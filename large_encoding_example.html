<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Geneie: An example for loading a large file into memory and encoding the entire contents at once</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Geneie
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">An example for loading a large file into memory and encoding the entire contents at once </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This code is an example of a program which, instead of reading three characters at a time and writing a character out, takes a file name as an argument and attempts to process the whole file contents in-memory in one pass.</p>
<p>As long as you have enough memory for the file, large genomes can be loaded and processed in a single step. While this version of the program doesn't <em>print</em> character amounts too high for printf, the whole file will still be processed.</p>
<p>If built with <code>-DBUILD_EXAMPLES=True</code>, this program should be under <code>pages/large_file_encoding</code>. Try running it passing a file with a complete DNA/mRNA sequence, a file with a gap '-' somewhere in the middle, and a sequence that starts with a gap '-'.</p>
<p>Finally, to see an amusing but harmless bug, try running the program with an empty file.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;errno.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;limits.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;geneie.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This example shows another use of geneie_sequence_ref,</span></div>
<div class="line"><span class="comment"> * using the geneie_sequence_tools_encode function to</span></div>
<div class="line"><span class="comment"> * encode a large sequence in-place.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * We use a geneie_sequence to allocate memory, populate</span></div>
<div class="line"><span class="comment"> * it with data from a file, then create a reference to</span></div>
<div class="line"><span class="comment"> * it for processing.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structgeneie__sequence.html">geneie_sequence</a> <a class="code" href="structgeneie__sequence.html">seq_t</a>;</div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structgeneie__sequence__ref.html">geneie_sequence_ref</a> <a class="code" href="structgeneie__sequence__ref.html">ref_t</a>;</div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structgeneie__sequence__tools__ref__pair.html">geneie_sequence_tools_ref_pair</a> <a class="code" href="structgeneie__sequence__tools__ref__pair.html">pair_t</a>;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Moved the processing to a separate function, so even if an</span></div>
<div class="line"><span class="comment"> * error is returned here, we can fclose() the file safely</span></div>
<div class="line"><span class="comment"> * in main().</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> process_file(FILE *file)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Most of this is just getting an amount of memory</span></div>
<div class="line"><span class="comment">     * to allocate for this file.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordflow">if</span> (fseek(file, 0, SEEK_END))</div>
<div class="line">        <span class="keywordflow">return</span> errno;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">long</span> length = ftell(file);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (length &lt; 0)</div>
<div class="line">        <span class="keywordflow">return</span> errno;</div>
<div class="line"> </div>
<div class="line">    rewind(file);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * geneie_sequence_alloc() will allocate length memory,</span></div>
<div class="line"><span class="comment">     * creating (and preserving) a null terminator for</span></div>
<div class="line"><span class="comment">     * convenience.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a class="code" href="structgeneie__sequence.html">seq_t</a> store = <a class="code" href="structgeneie__sequence.html#a0622bc4bd53f6b75d80952737d0def4c">geneie_sequence_alloc</a>(length);</div>
<div class="line">    <span class="keywordflow">if</span> (!<a class="code" href="structgeneie__sequence.html#a71851f74f637f1dfe30bc4a4584df377">geneie_sequence_valid</a>(store))</div>
<div class="line">        <span class="keywordflow">return</span> errno;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">size_t</span> read_amount = fread(store.<a class="code" href="structgeneie__sequence.html#af8e59ea34fcfab0da413bd3c5f6ebb12">codes</a>, 1, (<span class="keywordtype">size_t</span>)length, file);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (ferror(file)) {</div>
<div class="line">        <a class="code" href="structgeneie__sequence.html#a1c5c5eb0bd28edc30f4df4f652ffb654">geneie_sequence_free</a>(store);</div>
<div class="line">        <span class="keywordflow">return</span> ferror(file);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Most processing isn&#39;t performed against geneie_sequence</span></div>
<div class="line"><span class="comment">     * objects directly, instead it happens through a reference.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * This helps to simplify resource management - references</span></div>
<div class="line"><span class="comment">     * are never allocated and never freed; each sequence should</span></div>
<div class="line"><span class="comment">     * have been allocated, and each must be passed to</span></div>
<div class="line"><span class="comment">     * geneie_sequence_free().</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a class="code" href="structgeneie__sequence__ref.html">ref_t</a> <a class="code" href="structgeneie__sequence__ref.html">ref</a> = <a class="code" href="sequence__tools_8h.html#a0fa3a8a88b5a21b9ebb17e67cc369c04">geneie_sequence_tools_ref_from_sequence</a>(store);</div>
<div class="line">    <span class="comment">// only consider read amount</span></div>
<div class="line">    <a class="code" href="structgeneie__sequence__ref.html">ref</a> = <a class="code" href="structgeneie__sequence__ref.html#a16084c6f2824fc6ab288ead07b222d51">geneie_sequence_ref_trunc</a>(<a class="code" href="structgeneie__sequence__ref.html">ref</a>, (ssize_t)read_amount);</div>
<div class="line">    <span class="comment">// clean whitespace</span></div>
<div class="line">    <a class="code" href="structgeneie__sequence__ref.html">ref</a> = <a class="code" href="sequence__tools_8h.html#a784070c13c3df25371edcf33971f2208">geneie_sequence_tools_clean_whitespace</a>(<a class="code" href="structgeneie__sequence__ref.html">ref</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*</span></div>
<div class="line"><span class="comment">     * Finally, encode the data in-place.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * In-place encoding avoids the cost of allocating and copying</span></div>
<div class="line"><span class="comment">     * potentially huge amounts of data, at the cost of (obviously)</span></div>
<div class="line"><span class="comment">     * destroying the original data stored in the sequence.</span></div>
<div class="line"><span class="comment">     *</span></div>
<div class="line"><span class="comment">     * This function returns a pair of geneie_sequence_ref objects:</span></div>
<div class="line"><span class="comment">     * the first is the a sequence containing the amino acids that</span></div>
<div class="line"><span class="comment">     * could be encoded; the second contains the remainder of the</span></div>
<div class="line"><span class="comment">     * DNA/mRNA sequence, starting from the first codon that failed.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <a class="code" href="structgeneie__sequence__tools__ref__pair.html">pair_t</a> pair = <a class="code" href="sequence__tools_8h.html#ab7de189ca05d07b71e692e36e870b54f">geneie_sequence_tools_encode</a>(<a class="code" href="structgeneie__sequence__ref.html">ref</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (pair.refs[0].<a class="code" href="structgeneie__sequence__ref.html#a38c0244a506a5ce91bf20d809f9a3da4">length</a> &gt; INT_MAX)</div>
<div class="line">        printf(<span class="stringliteral">&quot;Encoded output too long for printf&quot;</span>);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pair.refs[0].<a class="code" href="structgeneie__sequence__ref.html#a38c0244a506a5ce91bf20d809f9a3da4">length</a> == 0)</div>
<div class="line">        printf(<span class="stringliteral">&quot;No DNA/mRNA encoded\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        <span class="comment">/*</span></div>
<div class="line"><span class="comment">         * The %.*s syntax here allows us to print only the</span></div>
<div class="line"><span class="comment">         * characters in the sequence. To learn more, check</span></div>
<div class="line"><span class="comment">         * the Precision section of the printf man page.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        printf(<span class="stringliteral">&quot;Encoded output: %.*s\n&quot;</span>, (<span class="keywordtype">int</span>)pair.refs[0].<a class="code" href="structgeneie__sequence__ref.html#a38c0244a506a5ce91bf20d809f9a3da4">length</a>, pair.refs[0].<a class="code" href="structgeneie__sequence__ref.html#a81bb1789b041d2171789d1a3f9c75ade">codes</a>);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (pair.refs[1].<a class="code" href="structgeneie__sequence__ref.html#a38c0244a506a5ce91bf20d809f9a3da4">length</a> &gt; INT_MAX)</div>
<div class="line">        printf(<span class="stringliteral">&quot;Remaining DNA/mRNA too long for printf&quot;</span>);</div>
<div class="line">    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pair.refs[1].<a class="code" href="structgeneie__sequence__ref.html#a38c0244a506a5ce91bf20d809f9a3da4">length</a> == 0)</div>
<div class="line">        printf(<span class="stringliteral">&quot;All DNA/mRNA encoded\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">        printf(<span class="stringliteral">&quot;Remaining DNA/mRNA: %.*s\n&quot;</span>, (<span class="keywordtype">int</span>)pair.refs[1].<a class="code" href="structgeneie__sequence__ref.html#a38c0244a506a5ce91bf20d809f9a3da4">length</a>, pair.refs[1].<a class="code" href="structgeneie__sequence__ref.html#a81bb1789b041d2171789d1a3f9c75ade">codes</a>);</div>
<div class="line"> </div>
<div class="line">    <a class="code" href="structgeneie__sequence.html#a1c5c5eb0bd28edc30f4df4f652ffb654">geneie_sequence_free</a>(store);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * All this main function does is check if a filename was given</span></div>
<div class="line"><span class="comment"> * as an argument, try to open the file, handle errors, then pass</span></div>
<div class="line"><span class="comment"> * the file on to process_file.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Finally, it safely closes the file and returns the result</span></div>
<div class="line"><span class="comment"> * of process_file.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (argc &lt; 2)</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line"> </div>
<div class="line">    FILE *file = fopen(argv[1], <span class="stringliteral">&quot;r&quot;</span>);</div>
<div class="line">    <span class="keywordflow">if</span> (!file)</div>
<div class="line">        <span class="keywordflow">return</span> errno;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">int</span> return_value = process_file(file);</div>
<div class="line">    fclose(file);</div>
<div class="line">    <span class="keywordflow">return</span> return_value;</div>
<div class="line">}</div>
<div class="ttc" id="asequence__tools_8h_html_a0fa3a8a88b5a21b9ebb17e67cc369c04"><div class="ttname"><a href="sequence__tools_8h.html#a0fa3a8a88b5a21b9ebb17e67cc369c04">geneie_sequence_tools_ref_from_sequence</a></div><div class="ttdeci">struct geneie_sequence_ref geneie_sequence_tools_ref_from_sequence(struct geneie_sequence sequence)</div><div class="ttdoc">Creates a reference from a sequence.</div></div>
<div class="ttc" id="asequence__tools_8h_html_a784070c13c3df25371edcf33971f2208"><div class="ttname"><a href="sequence__tools_8h.html#a784070c13c3df25371edcf33971f2208">geneie_sequence_tools_clean_whitespace</a></div><div class="ttdeci">struct geneie_sequence_ref geneie_sequence_tools_clean_whitespace(struct geneie_sequence_ref reference)</div><div class="ttdoc">Removes any whitespace characters from the sequence.</div><div class="ttdef"><b>Definition:</b> clean_whitespace.c:65</div></div>
<div class="ttc" id="asequence__tools_8h_html_ab7de189ca05d07b71e692e36e870b54f"><div class="ttname"><a href="sequence__tools_8h.html#ab7de189ca05d07b71e692e36e870b54f">geneie_sequence_tools_encode</a></div><div class="ttdeci">struct geneie_sequence_tools_ref_pair geneie_sequence_tools_encode(struct geneie_sequence_ref strand)</div><div class="ttdoc">Encodes mRNA sequences into amino acid sequences in-place.</div></div>
<div class="ttc" id="astructgeneie__sequence__ref_html"><div class="ttname"><a href="structgeneie__sequence__ref.html">geneie_sequence_ref</a></div><div class="ttdoc">Represents a sequence of codes, defined in code.h.</div><div class="ttdef"><b>Definition:</b> sequence_ref.h:46</div></div>
<div class="ttc" id="astructgeneie__sequence__ref_html_a16084c6f2824fc6ab288ead07b222d51"><div class="ttname"><a href="structgeneie__sequence__ref.html#a16084c6f2824fc6ab288ead07b222d51">geneie_sequence_ref::geneie_sequence_ref_trunc</a></div><div class="ttdeci">struct geneie_sequence_ref geneie_sequence_ref_trunc(struct geneie_sequence_ref ref, ssize_t length)</div><div class="ttdoc">Takes the given reference and returns a new reference with the length set to the given length.</div></div>
<div class="ttc" id="astructgeneie__sequence__ref_html_a38c0244a506a5ce91bf20d809f9a3da4"><div class="ttname"><a href="structgeneie__sequence__ref.html#a38c0244a506a5ce91bf20d809f9a3da4">geneie_sequence_ref::length</a></div><div class="ttdeci">ssize_t length</div><div class="ttdoc">The length of the gene sequence.</div><div class="ttdef"><b>Definition:</b> sequence_ref.h:54</div></div>
<div class="ttc" id="astructgeneie__sequence__ref_html_a81bb1789b041d2171789d1a3f9c75ade"><div class="ttname"><a href="structgeneie__sequence__ref.html#a81bb1789b041d2171789d1a3f9c75ade">geneie_sequence_ref::codes</a></div><div class="ttdeci">geneie_code * codes</div><div class="ttdoc">The beginning of the gene sequence.</div><div class="ttdef"><b>Definition:</b> sequence_ref.h:59</div></div>
<div class="ttc" id="astructgeneie__sequence__tools__ref__pair_html"><div class="ttname"><a href="structgeneie__sequence__tools__ref__pair.html">geneie_sequence_tools_ref_pair</a></div><div class="ttdoc">Provides a pair of references.</div><div class="ttdef"><b>Definition:</b> sequence_tools.h:139</div></div>
<div class="ttc" id="astructgeneie__sequence_html"><div class="ttname"><a href="structgeneie__sequence.html">geneie_sequence</a></div><div class="ttdoc">Represents a sequence of codes, defined in code.h.</div><div class="ttdef"><b>Definition:</b> sequence.h:46</div></div>
<div class="ttc" id="astructgeneie__sequence_html_a0622bc4bd53f6b75d80952737d0def4c"><div class="ttname"><a href="structgeneie__sequence.html#a0622bc4bd53f6b75d80952737d0def4c">geneie_sequence::geneie_sequence_alloc</a></div><div class="ttdeci">struct geneie_sequence geneie_sequence_alloc(ssize_t length)</div><div class="ttdoc">Allocates uninitialized memory for a geneie_sequence object and initializes its length member.</div></div>
<div class="ttc" id="astructgeneie__sequence_html_a1c5c5eb0bd28edc30f4df4f652ffb654"><div class="ttname"><a href="structgeneie__sequence.html#a1c5c5eb0bd28edc30f4df4f652ffb654">geneie_sequence::geneie_sequence_free</a></div><div class="ttdeci">void geneie_sequence_free(struct geneie_sequence sequence)</div><div class="ttdoc">Frees a given geneie_sequence.</div></div>
<div class="ttc" id="astructgeneie__sequence_html_a71851f74f637f1dfe30bc4a4584df377"><div class="ttname"><a href="structgeneie__sequence.html#a71851f74f637f1dfe30bc4a4584df377">geneie_sequence::geneie_sequence_valid</a></div><div class="ttdeci">bool geneie_sequence_valid(struct geneie_sequence sequence)</div><div class="ttdoc">Returns whether this is a valid geneie_sequence object.</div></div>
<div class="ttc" id="astructgeneie__sequence_html_af8e59ea34fcfab0da413bd3c5f6ebb12"><div class="ttname"><a href="structgeneie__sequence.html#af8e59ea34fcfab0da413bd3c5f6ebb12">geneie_sequence::codes</a></div><div class="ttdeci">geneie_code * codes</div><div class="ttdoc">The beginning of the gene sequence.</div><div class="ttdef"><b>Definition:</b> sequence.h:62</div></div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
